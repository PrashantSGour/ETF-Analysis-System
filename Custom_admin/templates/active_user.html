<!-- active_user.html -->
{% extends "base1.html" %}
{% block title %}Active User details{% endblock title %}
{% load static %}
{% block body %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>User details</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">User Data</li>
            </ol>
        </nav>
    </div>
    <div class="row">
        <div class="dropdown mb-2 col-md-2">
            <button class="btn btn-info dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Select user details
            </button>
            <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                <li><a class="dropdown-item" href="{% url 'users_data' %}">All Users</a></li>
                <li><a class="dropdown-item" href="{% url 'active_user' %}">Active Users</a></li>
                <li><a class="dropdown-item" href="{% url 'deactivate_user' %}">Deactivated Users</a></li>
            </ul>
        </div>
        <div class="dropdown mb-2 col-md-2">
            <button class="btn btn-light dropdown-toggle" type="button" id="filterSubscriptionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Filter by Subscription  
            </button>
            <ul class="dropdown-menu" aria-labelledby="filterSubscriptionDropdown">
                <li><a class="dropdown-item" href="#" data-filter="All">All</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Silver">Silver</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Gold">Gold</a></li>
                <li><a class="dropdown-item" href="#" data-filter="Diamond">Diamond</a></li>
            </ul>
        </div>
        <div class="dropdown mb-2 col-md-2" id="dropdown-sub" style="display: none;">
            <button class="btn btn-light dropdown-toggle" type="button" id="subscriptionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Silver  
            </button>
            <ul class="dropdown-menu" aria-labelledby="subscriptionDropdown">
                <li><a class="dropdown-item" href="#">Silver</a></li>
                <li><a class="dropdown-item" href="#">Gold</a></li>
                <li><a class="dropdown-item" href="#">Diamond</a></li>
            </ul>
        </div>
        <div class="dropdown mb-2 col-md-2" id="dropdown-dur" style="display: none;">
            <button class="btn btn-light dropdown-toggle" type="button" id="durationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            1 month
            </button>
            <ul class="dropdown-menu" aria-labelledby="durationDropdown">
                <li><a class="dropdown-item" href="#">1 month</a></li>
                <li><a class="dropdown-item" href="#">3 months</a></li>
                <li><a class="dropdown-item" href="#">6 months</a></li>
                <li><a class="dropdown-item" href="#">1 year</a></li>
            </ul>
        </div>
        <div class="dropdown mb-2 col-md-2" id="btn-apply" style="display: none;">
            <a class="btn btn-primary btn-block p-2 shadow rounded-pill" onclick="applyAndRefresh()" data-bs-dismiss="modal">Apply</a>
        </div>
    </div>
    
    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Users</h5>
                        <table class="table table-hover" id= 'userTable'>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" class="all-checkbox" id="select-all"></th>

                                    <th>S.no.</th>
                                    <th>Username</th>
                                    <th>Dob</th>
                                    <th>Phone</th>
                                    <th>IS verified</th>
                                    <th>Status</th>
                                    <th>Subscription</th>
                                    <th>Period</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in data %}
                                <tr>
                                    <td><input type="checkbox" class="data-checkbox" data-username="{{ user.username }}" onclick="toggleDropdownVisibility()"></td>

                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.date_of_birth }}</td>
                                    <td>{{ user.phone_number }}</td>
                                    <td>{{ user.is_verified }}</td>
                                    <td>{{ user.login_status }}</td>
                                    {% for wallet in wallet %}
                                    {% if user.username == wallet.user.username %}
                                        <td>{{ wallet.sub_status }}</td>
                                        <td>{{ wallet.period }}</td>
                                    {% endif %}
                                    {% endfor %}     
                                    <td>
                                        <button  type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ExtralargeModal">
                                           Transaction
                                          </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- Button to trigger the modal -->
    
    
      <div class="modal fade" id="ExtralargeModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Transaction details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">        
                        <div class="card">
                            <div class="card-body" style="overflow-x: auto !important;">
                                {% comment %} <div id="user_buy_history_url" data-url="{% url 'user_buy_history' %}"></div> {% endcomment %}
                                <h5 class="card-header fw-bolder text-center ">ETF Transactions</h5>
                                <div class="container-fluid">    
                                    <!-- Buy/Sell Dropdown -->
                                    <div class="row">
                                        <div class="dropdown col-md-4" >
                                            <button class="btn btn-outline-info dropdown-toggle   btn-sm mt-3" type="button" style="font-size:15px; z-index: 1005;" id="transactionTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span id="selectedOption">All</span>
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="transactionTypeDropdown" style="z-index: 1005;">
                                                <li><a class="dropdown-item" href="#" onclick="selectTransactionType('All');">All</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="selectTransactionType('Buy');">Buy</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="selectTransactionType('Sell');">Sell</a></li>
                                            </ul>
                                        </div>
                                        <!--Search Bar-->
                                        <div class="form-group has-search col-md-4">
                                            
                                            <input id="search" type="text" class="form-control mt-3" placeholder="Search"  >
                                            
                                        </div>
                                       
                                        
                                    </div>
                                </div>
                                
                                <!-- All Transactions Table -->
                                <table id="allTable" class="table table-hover mt-3"> 
                                    <thead>                           
                                        <tr>
                                            <th style="white-space: nowrap;">S. no. </th>
                                            <th style="white-space: nowrap;">Expand</th>
                                            <th style="white-space: nowrap;">ETF Name</th>
                                            <th style="white-space: nowrap;">Last Transaction</th>
                                            <th style="white-space: nowrap;">Total Quantity</th>
                                            <th style="white-space: nowrap;">Average Cost</th>
                                            <th style="white-space: nowrap;">Currrent Cost</th>
                                            <th style="white-space: nowrap;">Percentage diff</th>
                                            <th style="white-space: nowrap;">20 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 20 DMA</th> 
                                            <th style="white-space: nowrap;">20 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">50 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 50 DMA</th> 
                                            <th style="white-space: nowrap;">50 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">100 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 100 DMA</th> 
                                            <th style="white-space: nowrap;">100 DMA vs CMP</th> 
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for b in data_all %}
                                        <tr class="expandable-row-all">
                                            <td>{{ forloop.counter }}</td>
                                            <td><button class="expand-btn"><span class="expand-sign">+</span></button></td>
                                            <td>{{ b.etf_name }}</td>
                                            <td>{{ b.mod_date }}</td>
                                            <td>{{ b.total_quantity }}</td>
                                            <td>₹ {{ b.mod_avg|floatformat:2  }}</td>
                                            <td>₹ {{ b.current_price|floatformat:2  }}</td>
                                            <td style="color: 
                                                {% if b.percent_diff > 0 %}
                                                    green
                                                {% elif b.percent_diff < 0 %}
                                                    red
                                                {% else %}
                                                    black
                                                {% endif %}
                                                ;"
                                            >{{ b.percent_diff|floatformat:2 }}%</td>

                                            {% for key, value in b.20dma.items %}
                                                {% if key == b.etf_name %}
                                                    <td>{{ value|floatformat:2  }}</td>
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_minus_20dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_div_20dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}%</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}


                                            {% for key, value in b.50dma.items %}
                                                {% if key == b.etf_name %}
                                                    <td>{{ value|floatformat:2 }}</td>
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_minus_50dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_div_50dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}%</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}


                                            {% for key, value in b.100dma.items %}
                                                {% if key == b.etf_name %}
                                                    <td>{{ value|floatformat:2 }}</td>
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_minus_100dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            {% for key, value in b.etf_close_div_100dma.items %}
                                                {% if key == b.etf_name %}
                                                    {% if value < 0 %}
                                                        <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                    {% elif value > 0 %}
                                                        <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                    {% else %}
                                                        <td>{{ value|floatformat:2 }}%</td>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                    
                                        </tr>
                                        <tr class="details-row-all" style="display: none;">
                                            <td colspan="10">
                                                <table class="table table-light nested-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Quantity</th>
                                                            <th>Buy Cost</th>
                                                            <th>Buy Price</th>
                                                            <th>Current Cost</th>
                                                            <th>Current Price</th>
                                                            <th>% Difference</th>
                                                            <th>Trans type</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Add details rows here -->
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <!-- Sell Transactions Table (Initially hidden) -->
                                <table id="sellTable" class="table table-hover" style="display: none;"> 
                                    <thead>                           
                                        <tr>
                                            <th style="white-space: nowrap;">S. no. </th>
                                            <th style="white-space: nowrap;">Expand</th>
                                            <th style="white-space: nowrap;">ETF Name</th>
                                            <th style="white-space: nowrap;">Last Transaction</th>
                                            <th style="white-space: nowrap;">Total Quantity</th>
                                            <th style="white-space: nowrap;">Average Cost</th>
                                            <th style="white-space: nowrap;">Currrent Cost</th>
                                            <th style="white-space: nowrap;">Percentage diff</th>
                                            <th style="white-space: nowrap;">20 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 20 DMA</th> 
                                            <th style="white-space: nowrap;">20 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">50 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 50 DMA</th> 
                                            <th style="white-space: nowrap;">50 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">100 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 100 DMA</th> 
                                            <th style="white-space: nowrap;">100 DMA vs CMP</th> 
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for b in data_sell %}
                                            <tr class="expandable-row-sell">
                                                <td>{{ forloop.counter }}</td>
                                                <td><button class="expand-btn"><span class="expand-sign">+</span></button></td>
                                                <td>{{ b.etf_name }}</td>
                                                <td>{{ b.mod_date }}</td>
                                                <td>{{ b.total_quantity }}</td>
                                                <td>₹ {{ b.mod_avg|floatformat:2  }}</td>
                                                <td>₹ {{ b.current_price|floatformat:2  }}</td>
                                                <td style="color: 
                                                    {% if b.percent_diff > 0 %}
                                                        green
                                                    {% elif b.percent_diff < 0 %}
                                                        red
                                                    {% else %}
                                                        black
                                                    {% endif %}
                                                    ;"
                                                >{{ b.percent_diff|floatformat:2 }}%</td>

                                                {% for key, value in b.20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2  }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_minus_20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_div_20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}


                                                {% for key, value in b.50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_minus_50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_div_50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}


                                                {% for key, value in b.100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_minus_100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_div_100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                        
                                            </tr>
                                        <tr class="details-row-sell" style="display: none;">
                                            <td colspan="10">
                                                <table class="table table-light nested-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Quantity</th>
                                                            <th>Buy Cost</th>
                                                            <th>Buy Price</th>
                                                            <th>Current Cost</th>
                                                            <th>Current Price</th>
                                                            <th>% Difference</th>
                                                            <th>Trans type</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Add details rows here -->
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <!-- Buy Transactions Table (Initially hidden) -->
                                <table id="buyTable" class="table table-hover" style="display: none;"> 
                                    <thead>                           
                                        <tr>
                                            <th style="white-space: nowrap;">S. no. </th>
                                            <th style="white-space: nowrap;">Expand</th>
                                            <th style="white-space: nowrap;">ETF Name</th>
                                            <th style="white-space: nowrap;">Last Transaction</th>
                                            <th style="white-space: nowrap;">Total Quantity</th>
                                            <th style="white-space: nowrap;">Average Cost</th>
                                            <th style="white-space: nowrap;">Currrent Cost</th>
                                            <th style="white-space: nowrap;">Percentage diff</th>
                                            <th style="white-space: nowrap;">20 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 20 DMA</th> 
                                            <th style="white-space: nowrap;">20 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">50 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 50 DMA</th> 
                                            <th style="white-space: nowrap;">50 DMA vs CMP</th> 
                                            <th style="white-space: nowrap;">100 DMA</th> 
                                            <th style="white-space: nowrap;">CMP - 100 DMA</th> 
                                            <th style="white-space: nowrap;">100 DMA vs CMP</th> 
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for b in data_buy %}
                                            <tr class="expandable-row-buy">
                                                <td>{{ forloop.counter }}</td>
                                                <td><button class="expand-btn"><span class="expand-sign">+</span></button></td>
                                                <td>{{ b.etf_name }}</td>
                                                <td>{{ b.mod_date }}</td>
                                                <td>{{ b.total_quantity }}</td>
                                                <td>₹ {{ b.mod_avg|floatformat:2  }}</td>
                                                <td>₹ {{ b.current_price|floatformat:2  }}</td>
                                                <td style="color: 
                                                    {% if b.percent_diff > 0 %}
                                                        green
                                                    {% elif b.percent_diff < 0 %}
                                                        red
                                                    {% else %}
                                                        black
                                                    {% endif %}
                                                    ;"
                                                >{{ b.percent_diff|floatformat:2 }}%</td>
                                                {% for key, value in b.20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2  }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                {% for key, value in b.etf_close_minus_20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                    
                                                {% for key, value in b.etf_close_div_20dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}


                                                {% for key, value in b.etf_data_50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                <!-- Close - 50DMA -->
                                                {% for key, value in b.etf_close_minus_50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                <!-- Close / 50DMA -->
                                                {% for key, value in b.etf_close_div_50dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}


                                                {% for key, value in b.etf_data_100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        <td>{{ value|floatformat:2 }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                                <!-- Close - 50DMA -->
                                                {% for key, value in b.etf_close_minus_100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                <!-- Close / 50DMA -->
                                                {% for key, value in b.etf_close_div_100dma.items %}
                                                    {% if key == b.etf_name %}
                                                        {% if value < 0 %}
                                                            <td style="color: red">{{ value|floatformat:2 }}%</td>
                                                        {% elif value > 0 %}
                                                            <td style="color: green">{{ value|floatformat:2 }}%</td>
                                                        {% else %}
                                                            <td>{{ value|floatformat:2 }}%</td>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                        
                                            </tr>
                                        <tr class="details-row-buy" style="display: none;">
                                            <td colspan="10">
                                                <table class="table table-light nested-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Quantity</th>
                                                            <th>Buy Cost</th>
                                                            <th>Buy Price</th>
                                                            <th>Current Cost</th>
                                                            <th>Current Price</th>
                                                            <th>% Difference</th>
                                                            <th>Trans type</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Add details rows here -->
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              
            </div>
          </div>
        </div>
      </div><!-- End Extra Large Modal-->
    
 <!-- Extra Large Modal -->
 

</main>
<div class="modal fade" id="messageContainer" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info text-black bi-text-left" style="z-index: 1000;">
                    <ul>
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Override default Bootstrap styles */

    .card-body {
        position: relative; /* Ensure relative positioning for absolute positioning of button and dropdown */
    }
    
    .container-fluid {
        padding-right: 0;
        padding-left: 0;
        margin-right: auto;
        margin-left: auto;
         
    }


    .row {
        margin-right: 0;
        margin-left: 0;
    }

    .modal-dialog {
        max-width: 900px !important; /* Adjust the width as needed */
        padding-top: 0px !important; /* Adjust the top padding as needed */
        padding-bottom: 0px !important; /* Adjust the bottom padding as needed */
        flex-direction: column !important; /* Align items vertically */
        justify-content: center !important; /* Center items horizontally */  
    }
    
    .justify-content-end {
        margin-left: auto !important; /* Override Bootstrap's margin-left */
    }

    .expand-btn {
        background-color: transparent; /* Set background color to black */
        color: black; /* Set text color to white */
        border: none; /* Remove border */
        padding: 5px 10px; /* Adjust padding */
        font-size: 14px; /* Adjust font size */
        cursor: pointer; /* Set cursor to pointer */
    }
    /* Custom Toggle Switch Button Styles */
    .toggle-card {
        display: flex;
        flex-direction: column; /* Align items vertically */
        justify-content: center; /* Center items horizontally */  
        align-items: center; /* Center items vertically */
        margin-top: 0px !important;
        
    }
    .toggle-container {
        position: relative;
        display: inline-block;
        width: 85px; /* Adjust width as needed */
        height: 34px;
        align-items: center;
    }

    .toggle-container input[type=checkbox] {
        display: none; /* Hide the default checkbox */
    }

    .toggle-label {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #4CAF50; /* Green color for "Buy" background by default */
        border-radius: 34px; /* Rounded corners */
        transition: background-color 0.3s; /* Smooth transition */
        display: flex;
        align-items: center;
        justify-content: space-between; /* Aligns items with space in between */
        padding: 0 10px; /* Add padding to space out the labels */
    }

    .toggle-container input[type=checkbox]:checked + .toggle-label {
        background-color: #4CAF50; /* Green color for "Buy" background when checked */
    }

    .toggle-container input[type=checkbox]:not(:checked) + .toggle-label {
        background-color: #f44336; /* Red color for "Sell" background when unchecked */
    }

    .toggle-label::before {
        content: "Buy";
        color: white;
        font-weight: bold;
        font-family: Arial, sans-serif;
        margin-right: auto; /* Pushes "Buy" to the left */
        
    }

    .toggle-container input[type=checkbox]:not(:checked) + .toggle-label::before {
        content: "Sell";
        margin-left: 55%; /* Pushes "Sell" to the left */
        
    }

    .toggle-button {
        position: absolute;
        top: 2px;
        right: 2px; /* Position the button on the right by default */
        width: 30px; /* Width of the small grey button */
        height: 30px; /* Height of the small grey button */
        background-color: #fff; /* White color for the button */
        border-radius: 50%; /* Rounded button */
        transition: transform 0.3s, right 0.3s, left 0.3s; /* Smooth transition for transform and right properties */
    }

    .toggle-container input[type=checkbox]:checked + .toggle-label .toggle-button {
        right: 2px; /* Position the button on the right when checked */
        transform: translateX(0); /* Reset transform when checked */
    }

    .toggle-container input[type=checkbox]:not(:checked) + .toggle-label .toggle-button {
        left: 2px; /* Position the button on the left when unchecked */
        transform: translateX(0); /* Reset transform when unchecked */
    }
    .expand-sign {
        font-weight: bold;
        font-size: 1.6em; /* Adjust font size as needed */
    }
      
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function applyFilter() {
        var selectedFilter = document.getElementById("filterSubscriptionDropdown").textContent.trim();
        var rows = document.getElementById("userTable").getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        console.log(selectedFilter);
        for (var i = 0; i < rows.length; i++) {
            var subscriptionCell = rows[i].getElementsByTagName("td")[7];
            if (subscriptionCell) {
                var subscription = subscriptionCell.textContent.trim();
                if (selectedFilter === "All" || subscription === selectedFilter) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }

    document.querySelectorAll('#filterSubscriptionDropdown .dropdown-item').forEach(item => {
        item.addEventListener('click', event => {
            var filter = event.target.textContent;
            document.getElementById("filterSubscriptionDropdown").textContent = "Filter by Subscription: " + filter; // Update the label
            applyFilter(); // Call applyFilter function to filter the table based on the selected option
        });
    });
</script>

<script>
    function applyAndRefresh() {
        fetchSubscriptionDetails(getSelectedsubscription('subscription'), getSelectedTimePeriod('duration'), getSelectedUsernames())
            .finally(() => {
                location.reload(); // Reload the page regardless of whether fetchSubscriptionDetails succeeds or fails
            });
    }
    

    function getSelectedUsernames() {
        const checkboxes = document.querySelectorAll('.data-checkbox:checked');
        const selectedUsernames = Array.from(checkboxes).map(checkbox => checkbox.dataset.username);
        return selectedUsernames;
    }
    
    function getSelectedsubscription(card) {
        // Get the selected option from the dropdown menu
        const dropdown = document.getElementById(card + 'Dropdown');
        const selectedOption = dropdown.textContent.trim(); // Trim to remove any leading/trailing whitespace
        console.log(selectedOption);
        return selectedOption;
      }

    function getSelectedTimePeriod(card) {
        // Get the selected option from the dropdown menu
        const dropdown = document.getElementById('durationDropdown');
        const selectedOption = dropdown.textContent.trim(); // Trim to remove any leading/trailing whitespace
        console.log(selectedOption);
        return selectedOption;
      }
  
      // Function to fetch subscription details based on selected subscription type and time period
      function fetchSubscriptionDetails(subscriptionType, timePeriod,  selectedUsernames) {
        let fetchUrl = '/customadmin/active_user/'; // Replace with your Django URL for fetching subscription details
        const csrftoken = getCookie('csrftoken');
        const requestBody = {
            subscriptionType: subscriptionType,
            timePeriod: timePeriod,
            selectedUsernames: selectedUsernames
        };
  
        fetch(fetchUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(requestBody)
        })
      }
  
      // Function to get CSRF token from cookie
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }
</script> 

<script>
    document.getElementById('select-all').addEventListener('change', function () {
    var checkboxes = document.querySelectorAll('.data-checkbox');
    checkboxes.forEach(function (checkbox) {
        checkbox.checked = this.checked;
    }.bind(this));
    toggleDropdownVisibility();
  });

    document.addEventListener('DOMContentLoaded', function() {
    var checkboxes = document.querySelectorAll('.data-checkbox');
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('click', toggleDeleteButtonVisibility);
    });
});

function toggleDropdownVisibility() {
    var dropdownbutton = document.getElementById('dropdown-sub');
    var dropdownbutton2 = document.getElementById('dropdown-dur');
    var btn3 = document.getElementById('btn-apply');

    var checkboxes = document.querySelectorAll('.data-checkbox:checked');
    
    if (checkboxes.length > 0) {
        dropdownbutton.style.display = '';
        dropdownbutton2.style.display = '';
        btn3.style.display = '';

    } else {
        dropdownbutton.style.display = 'none';
        dropdownbutton2.style.display = 'none';
        btn3.style.display = 'none';


    }
}

document.addEventListener('DOMContentLoaded', function() {
    var subscriptionDropdown = document.getElementById('subscriptionDropdown');
    var durationDropdown = document.getElementById('durationDropdown');
    
    // Event listener for subscription dropdown items
    var subscriptionItems = document.querySelectorAll('#dropdown-sub .dropdown-item');
    subscriptionItems.forEach(function(item) {
        item.addEventListener('click', function() {
            subscriptionDropdown.innerHTML = this.innerHTML;
        });
    });
    
    // Event listener for duration dropdown items
    var durationItems = document.querySelectorAll('#dropdown-dur .dropdown-item');
    durationItems.forEach(function(item) {
        item.addEventListener('click', function() {
            durationDropdown.innerHTML = this.innerHTML;
        });
    });
});


</script>

<script>
    // JavaScript function to trigger the modal
    $(document).ready(function() {
        {% if messages %}
            $('#messageContainer').modal('show');
        {% endif %}
    });

    // JavaScript function for selecting transaction type
    function selectTransactionType(type) {
        document.getElementById("selectedOption").innerText = type;
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function filterRows() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("search");
            filter = input.value.toUpperCase();
            table = document.getElementById("allTable");
            tr = table.getElementsByTagName("tr");
        
            // Loop through all table rows
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[2]; // Change index to match the column of ETF names
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (filter === "" || txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = ""; // Show row if it matches search or if search is empty
                    } else {
                        tr[i].style.display = "none"; // Hide row if it doesn't match search
                        // Hide details row when search is cleared
                        const detailsRow = tr[i].nextElementSibling;
                        if (detailsRow && detailsRow.classList.contains('details-row')) {
                            detailsRow.style.display = "none";
                        }
                    }
                }
            }
        }
        

    
        // Attach filter function to input field
        document.getElementById("search").addEventListener("keyup", filterRows);
    });

  

</script>

<script>
      
    

    // Function to initialize the page
    function initializePage() {
        // Set the default transaction type to 'All' when the page is loaded
        selectTransactionType('All');
    }

    function selectTransactionType(transactionType) {
        console.log('Transaction type selected:', transactionType); // Debug statement
        var allTable = document.getElementById('allTable');
        var buyTable = document.getElementById('buyTable'); // Added buyTable variable
        var sellTable = document.getElementById('sellTable');
        var dropdownToggle = document.getElementById('transactionTypeDropdown');
        var selectedOption = document.getElementById('selectedOption'); // Added selectedOption variable
        
        if (transactionType === 'All') {
            console.log('Displaying All transactions table.'); // Debug statement
            allTable.style.display = 'table';
            buyTable.style.display = 'none';
            sellTable.style.display = 'none';
            dropdownToggle.innerText = 'All';
        } else if (transactionType === 'Buy') {
            console.log('Displaying Buy transactions table.'); // Debug statement
            allTable.style.display = 'none';
            buyTable.style.display = 'table';
            sellTable.style.display = 'none';
            dropdownToggle.innerText = 'Buy';
        } else if (transactionType === 'Sell') {
            console.log('Displaying Sell transactions table.'); // Debug statement
            allTable.style.display = 'none';
            buyTable.style.display = 'none';
            sellTable.style.display = 'table';
            dropdownToggle.innerText = 'Sell';
        }

        // Set font size for the selected option
        selectedOption.style.fontSize = '100px';
    }
    // Event listener for modal shown event
    document.getElementById('ExtralargeModal').addEventListener('shown.bs.modal', function () {
        // Attach event listeners to expand buttons inside the modal
        attachExpandButtonListeners();
    });

    // Event listener for DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the page
        initializePage();
    });

        function attachExpandButtonListeners() {
            const expandButtons = document.querySelectorAll('.expand-btn');
        
            expandButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Determine the parent table of the clicked button
                    const parentTable = this.closest('table');
                    console.log(parentTable);
                    // Determine the class name for expandable rows and details rows based on the parent table
                    let expandableRowClass, detailsRowClass;
                    if (parentTable.id === 'allTable') {
                        expandableRowClass = 'expandable-row-all';
                        detailsRowClass = 'details-row-all';
                    } else if (parentTable.id === 'buyTable') {
                        expandableRowClass = 'expandable-row-buy';
                        detailsRowClass = 'details-row-buy';
                    } else if (parentTable.id === 'sellTable') {
                        expandableRowClass = 'expandable-row-sell';
                        detailsRowClass = 'details-row-sell';
                    }
        
                    // Find the corresponding expandable row and details row
                    const row = this.closest('.' + expandableRowClass);
                    const detailsRow = row.nextElementSibling;
                    var username = row.querySelector('td:nth-child(2)').textContent; // Extract username from the second column
                    console.log('Username:', username); // Debug statement
                    
                    // Extract ETF Name from the row
                    const ETFName = row.querySelector('td:nth-child(3)').textContent.trim();
        
                    // Toggle display of details row
                    if (detailsRow.style.display === "none" || detailsRow.style.display === "") {
                        detailsRow.style.display = "table-row";
                        row.classList.add('table-info');
                        button.innerHTML = '<span class="expand-sign">-</span>'; // Change button content to minus sign when expanding
        
                        // Fetch details based on the parent table
                        if (parentTable.id === 'allTable') {
                            fetchDetailsAll(username, ETFName, detailsRow.querySelector('.nested-table'));
                        } else if (parentTable.id === 'buyTable') {
                            fetchDetailsBuy(username, ETFName, detailsRow.querySelector('.nested-table'));
                        } else if (parentTable.id === 'sellTable') {
                            fetchDetailsSell(username, ETFName, detailsRow.querySelector('.nested-table'));
                        }
                    } else {
                        detailsRow.style.display = "none";
                        row.classList.remove('table-info');
                        button.innerHTML = '<span class="expand-sign">+</span>'; // Change button content to plus sign when collapsing
                    }
            
                    // Reapply the styles to the expand sign
                    const expandSign = button.querySelector('.expand-sign');
                    expandSign.style.fontWeight = 'bold';
                    expandSign.style.fontSize = '1.6em'; // Adjust font size as needed
                });
            });
            
      
        // Function to fetch details data based on selected transaction type
        function fetchDetailsBuy(username, ETFName, detailsRow) {
            let fetchUrl;

            fetchUrl = '/customadmin/admintransdetails/';
            // Fetch data from the corresponding URL
            const csrftoken = getCookie('csrftoken');
            const requestBody = {
                ETFName: ETFName,
                username: username,
            };

            fetch(fetchUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.detailed_data) {
                    
                    updateDetailsBuy(data.detailed_data, detailsRow);
                } else {
                    console.error('Invalid or missing detailed data:', data);
                }
            })
            .catch(error => console.error('Error fetching details:', error));
        }

        
        
            
        function updateDetailsBuy(data, detailsRow) {
            const tableBody = detailsRow.querySelector('tbody');
            tableBody.innerHTML = '';
            data.forEach(entry => {
                const formattedDateTime = formatDateTime(entry.Date_time); // Format the date-time
                console.log('Data should be shown:',data);
                // Format Cost
                const costString = entry.Cost.toString(); // Convert cost to string
                const costParts = costString.split('.'); // Split the string into parts before and after the decimal point
                const costFormattedDecimal = costParts.length > 1 ? costParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCost = ` ₹ ${costParts[0]}.${costFormattedDecimal.padEnd(2, '0')}`;
        
                // Format Purchase Close Value
                const purchaseCloseString = entry.Purchase_close_value.toString(); // Convert purchase close value to string
                const purchaseCloseParts = purchaseCloseString.split('.'); // Split the string into parts before and after the decimal point
                const purchaseCloseFormattedDecimal = purchaseCloseParts.length > 1 ? purchaseCloseParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedPurchaseClose = ` ${purchaseCloseParts[0]}.${purchaseCloseFormattedDecimal.padEnd(2, '0')}`;
        
                // Format CurrCost
                const currCostString = entry.CurrCost.toString(); // Convert CurrCost to string
                const currCostParts = currCostString.split('.'); // Split the string into parts before and after the decimal point
                const currCostFormattedDecimal = currCostParts.length > 1 ? currCostParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrCost = ` ₹ ${currCostParts[0]}.${currCostFormattedDecimal.padEnd(2, '0')} `;
        
                // Format CurrPrice
                const currPriceString = entry.CurrPrice.toString(); // Convert CurrPrice to string
                const currPriceParts = currPriceString.split('.'); // Split the string into parts before and after the decimal point
                const currPriceFormattedDecimal = currPriceParts.length > 1 ? currPriceParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrPrice = ` ${currPriceParts[0]}.${currPriceFormattedDecimal.padEnd(2, '0')}`;
        
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDateTime}</td>
                    <td>${entry.Quantity}</td>
                    <td>${formattedCost}</td> <!-- Display Cost with exactly 2 digits after the decimal point -->
                    <td>${formattedPurchaseClose}</td> <!-- Display Purchase Close Value with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrCost}</td> <!-- Display CurrCost with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrPrice}</td> <!-- Display CurrPrice with exactly 2 digits after the decimal point -->
                    <td style="color: 
                    ${entry.PercentDiff > 0 ? 'green' : entry.PercentDiff < 0 ? 'red' : 'black'};">${entry.PercentDiff}%</td> <!-- Percentage Difference between Current cost and Buy Cost -->
                    <td style="color: ${entry.trans_type === 'BUY' ? 'green' : 'red'};"><strong>${entry.trans_type}</strong></td>
                    `;
        
                tableBody.appendChild(row);
            });
            detailsRow.style.display = "";
        }

        // Function to fetch details data based on selected transaction type
        function fetchDetailsSell( username, ETFName, detailsRow) {
            let fetchUrl;

            fetchUrl = '/customadmin/adminsellhistory/';
            // Fetch data from the corresponding URL
            const csrftoken = getCookie('csrftoken');
            const requestBody = {
                ETFName: ETFName,
                username: username,
            };

            fetch(fetchUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.detailed_data) {
                    
                    updateDetailsSell(data.detailed_data, detailsRow);
                } else {
                    console.error('Invalid or missing detailed data:', data);
                }
            })
            .catch(error => console.error('Error fetching details:', error));
        }

        
        
            
        function updateDetailsSell(data, detailsRow) {
            const tableBody = detailsRow.querySelector('tbody');
            tableBody.innerHTML = '';
            data.forEach(entry => {
                const formattedDateTime = formatDateTime(entry.Date_time); // Format the date-time
                console.log('Data should be shown:',data);
                // Format Cost
                const costString = entry.Cost.toString(); // Convert cost to string
                const costParts = costString.split('.'); // Split the string into parts before and after the decimal point
                const costFormattedDecimal = costParts.length > 1 ? costParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCost = ` ₹ ${costParts[0]}.${costFormattedDecimal.padEnd(2, '0')}`;
        
                // Format Purchase Close Value
                const purchaseCloseString = entry.Purchase_close_value.toString(); // Convert purchase close value to string
                const purchaseCloseParts = purchaseCloseString.split('.'); // Split the string into parts before and after the decimal point
                const purchaseCloseFormattedDecimal = purchaseCloseParts.length > 1 ? purchaseCloseParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedPurchaseClose = ` ${purchaseCloseParts[0]}.${purchaseCloseFormattedDecimal.padEnd(2, '0')}`;
        
                // Format CurrCost
                const currCostString = entry.CurrCost.toString(); // Convert CurrCost to string
                const currCostParts = currCostString.split('.'); // Split the string into parts before and after the decimal point
                const currCostFormattedDecimal = currCostParts.length > 1 ? currCostParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrCost = ` ₹ ${currCostParts[0]}.${currCostFormattedDecimal.padEnd(2, '0')} `;
        
                // Format CurrPrice
                const currPriceString = entry.CurrPrice.toString(); // Convert CurrPrice to string
                const currPriceParts = currPriceString.split('.'); // Split the string into parts before and after the decimal point
                const currPriceFormattedDecimal = currPriceParts.length > 1 ? currPriceParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrPrice = ` ${currPriceParts[0]}.${currPriceFormattedDecimal.padEnd(2, '0')}`;
        
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDateTime}</td>
                    <td>${entry.Quantity}</td>
                    <td>${formattedCost}</td> <!-- Display Cost with exactly 2 digits after the decimal point -->
                    <td>${formattedPurchaseClose}</td> <!-- Display Purchase Close Value with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrCost}</td> <!-- Display CurrCost with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrPrice}</td> <!-- Display CurrPrice with exactly 2 digits after the decimal point -->
                    <td style="color: 
                    ${entry.PercentDiff > 0 ? 'green' : entry.PercentDiff < 0 ? 'red' : 'black'};">${entry.PercentDiff}%</td> <!-- Percentage Difference between Current cost and Buy Cost -->
                    <td style="color: ${entry.trans_type === 'BUY' ? 'green' : 'red'};"><strong>${entry.trans_type}</strong></td>
                    `;
        
                tableBody.appendChild(row);
            });
            detailsRow.style.display = "";
        }

        // Function to fetch details data based on selected transaction type
        function fetchDetailsAll( username, ETFName, detailsRow) {
            let fetchUrl;

            fetchUrl = '/customadmin/adminallhistory/';
            // Fetch data from the corresponding URL
            const csrftoken = getCookie('csrftoken');
            const requestBody = {
                ETFName: ETFName,
                username: username,
            };

            fetch(fetchUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.detailed_data) {
                    
                    updateDetailsAll(data.detailed_data, detailsRow);
                } else {
                    console.error('Invalid or missing detailed data:', data);
                }
            })
            .catch(error => console.error('Error fetching details:', error));
        }

        
        
            
        function updateDetailsAll(data, detailsRow) {
            const tableBody = detailsRow.querySelector('tbody');
            tableBody.innerHTML = '';
            data.forEach(entry => {
                const formattedDateTime = formatDateTime(entry.Date_time); // Format the date-time
                console.log('Data should be shown:',data);
                // Format Cost
                const costString = entry.Cost.toString(); // Convert cost to string
                const costParts = costString.split('.'); // Split the string into parts before and after the decimal point
                const costFormattedDecimal = costParts.length > 1 ? costParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCost = ` ₹ ${costParts[0]}.${costFormattedDecimal.padEnd(2, '0')}`;
        
                // Format Purchase Close Value
                const purchaseCloseString = entry.Purchase_close_value.toString(); // Convert purchase close value to string
                const purchaseCloseParts = purchaseCloseString.split('.'); // Split the string into parts before and after the decimal point
                const purchaseCloseFormattedDecimal = purchaseCloseParts.length > 1 ? purchaseCloseParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedPurchaseClose = ` ${purchaseCloseParts[0]}.${purchaseCloseFormattedDecimal.padEnd(2, '0')}`;
        
                // Format CurrCost
                const currCostString = entry.CurrCost.toString(); // Convert CurrCost to string
                const currCostParts = currCostString.split('.'); // Split the string into parts before and after the decimal point
                const currCostFormattedDecimal = currCostParts.length > 1 ? currCostParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrCost = ` ₹ ${currCostParts[0]}.${currCostFormattedDecimal.padEnd(2, '0')} `;
        
                // Format CurrPrice
                const currPriceString = entry.CurrPrice.toString(); // Convert CurrPrice to string
                const currPriceParts = currPriceString.split('.'); // Split the string into parts before and after the decimal point
                const currPriceFormattedDecimal = currPriceParts.length > 1 ? currPriceParts[1].substring(0, 2) : '00'; // Ensure exactly two decimal places
                const formattedCurrPrice = ` ${currPriceParts[0]}.${currPriceFormattedDecimal.padEnd(2, '0')}`;
        
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDateTime}</td>
                    <td>${entry.Quantity}</td>
                    <td>${formattedCost}</td> <!-- Display Cost with exactly 2 digits after the decimal point -->
                    <td>${formattedPurchaseClose}</td> <!-- Display Purchase Close Value with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrCost}</td> <!-- Display CurrCost with exactly 2 digits after the decimal point -->
                    <td>${formattedCurrPrice}</td> <!-- Display CurrPrice with exactly 2 digits after the decimal point -->
                    <td style="color: 
                    ${entry.PercentDiff > 0 ? 'green' : entry.PercentDiff < 0 ? 'red' : 'black'};">${entry.PercentDiff}%</td> <!-- Percentage Difference between Current cost and Buy Cost -->
                    <td style="color: ${entry.trans_type === 'BUY' ? 'green' : 'red'};"><strong>${entry.trans_type}</strong></td>
                    `;
        
                tableBody.appendChild(row);
            });
            detailsRow.style.display = "";
        }

        
        
        // Function to format date-time
        function formatDateTime(dateTimeString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: '2-digit', 
                
            };
            const dateTime = new Date(dateTimeString);
            return dateTime.toLocaleString('en-US', options);
        }
        
    
        // Function to get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
      
      
         
  
  </script>
     
<script>
    // Function to handle transaction button click
    function handleTransactionClick(row) {
        var name = row.cells[1].innerText; // Get the value of the first column
        const csrftoken = getCookie('csrftoken');
        // Send the value to the backend URL using fetch API
        fetch('/customadmin/admintrans/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ name: name }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.dataall) {
                throw new Error('Invalid response format or missing data_all property');
            }
            populateTable(data.dataall);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function populateTable(data) {
        var tableBody = document.querySelector('#allTable tbody');
        tableBody.innerHTML = ''; // Clear existing table rows
        data.forEach(entry => {
            var row = document.createElement('tr');
            row.classList.add('expandable-row');
            console.log('Data should be shown:',data);
            // Add table cells
            row.innerHTML = `
                
                <td><button class="expand-btn"><span class="expand-sign">+</span></button></td>
                <td>${entry.etf_name}</td>
                <td>${entry.mod_date}</td>
                <td>${entry.total_quantity}</td>
                <td>₹ ${entry.mod_avg.toFixed(2)}</td>
                <td>₹ ${entry.current_price.toFixed(2)}</td>
                <td style="color: ${entry.percent_diff > 0 ? 'green' : entry.percent_diff < 0 ? 'red' : 'black'};">${entry.percent_diff.toFixed(2)}%</td>
                <td>${entry['20dma'][entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_minus_20dma[entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_div_20dma[entry.etf_name].toFixed(2)}%</td>
                <td>${entry['50dma'][entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_minus_50dma[entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_div_50dma[entry.etf_name].toFixed(2)}%</td>
                <td>${entry['100dma'][entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_minus_100dma[entry.etf_name].toFixed(2)}</td>
                <td>${entry.etf_close_div_100dma[entry.etf_name].toFixed(2)}%</td>
            `;

            tableBody.appendChild(row);
        });
    }

    // Function to get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add event listener to all transaction buttons
    document.querySelectorAll('.btn.btn-primary').forEach(button => {
        button.addEventListener('click', function() {
            var row = this.closest('tr'); // Get the parent row of the clicked button
            handleTransactionClick(row);
        });
    });
</script>


<script>
    // Function to hide messages after a delay
    function hideMessages() {
        $('#message-container').fadeOut(2000); // Fade out the message container in 1 second
    }
  
    // Call hideMessages function after 2-3 seconds (2000-3000 milliseconds)
    setTimeout(hideMessages, 3000); // Change the timeout delay as needed
</script>


<script>
   
    document.addEventListener("DOMContentLoaded", function() {
        // Get all transaction buttons
        var transactionButtons = document.querySelectorAll('.btn-primary');

        // Add click event listener to each transaction button
        transactionButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // Get the username from the current row
                var username = this.parentNode.previousElementSibling.previousElementSibling.textContent;

                // Get CSRF token
                var csrfToken = getCookie('csrftoken');

                // Send AJAX request to backend view
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/customadmin/active_user/', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', csrfToken); // Include CSRF token in the request header
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        console.log('Transaction request sent successfully');
                        // You can add further logic here if needed
                    } else {
                        console.error('Error sending transaction request. Status: ' + xhr.status);
                    }
                };
                xhr.onerror = function() {
                    console.error('Error sending transaction request. Network error occurred.');
                };
                xhr.send(JSON.stringify({username: username}));
            });
        });
    });

    // Function to get CSRF token from cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Check if the cookie name matches the desired name
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
 


</script>
<script>
    function toggleDetails(button) {
        var row = button.parentNode.parentNode; // Get the parent row of the button
        var detailsRow = row.nextElementSibling; // Get the next row which contains details
        if (detailsRow.style.display === "table-row") {
            detailsRow.style.display = "none";
            button.querySelector(".expand-sign").innerText = "+";
        } else {
            detailsRow.style.display = "table-row";
            button.querySelector(".expand-sign").innerText = "-";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var expandButtons = document.querySelectorAll(".expand-btn-all");
        expandButtons.forEach(function(button) {
            button.addEventListener("click", function() {
                toggleDetails(this);
            });
        });
    });
</script>


{% endblock body %}
